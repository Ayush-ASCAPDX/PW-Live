<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moderation | ASCAPDX Digital</title>
  <meta name="robots" content="noindex, nofollow">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Sora:wght@600;700&display=swap");
    :root {
      --panel: rgba(14, 30, 51, 0.78);
      --line: rgba(153, 197, 244, 0.22);
      --text: #eaf5ff;
      --muted: #a8c3de;
      --primary: #31c0ff;
      --secondary: #46e0b6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Manrope", sans-serif;
      background: radial-gradient(circle at 80% -25%, #1b3c65 0%, #0a1528 45%, #050a12 100%);
    }
    .glass-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 40;
      background: linear-gradient(120deg, rgba(7, 18, 34, 0.86), rgba(11, 26, 46, 0.62));
      border-bottom: 1px solid rgba(196, 220, 250, 0.16);
      backdrop-filter: blur(14px);
    }
    .nav-link {
      border-radius: 999px;
      padding: 0.5rem 0.8rem;
      color: #e8f3ff !important;
    }
    .nav-link:hover,
    .nav-link.active {
      background: rgba(64, 168, 255, 0.2);
    }
    main {
      min-height: 100vh;
      padding: 6.6rem 1rem 1rem;
      display: grid;
      place-items: start center;
    }
    .shell {
      width: min(1000px, 96vw);
      border: 1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(145deg, var(--panel), rgba(8, 20, 36, 0.72));
      box-shadow: 0 20px 45px rgba(2, 8, 16, 0.4);
      padding: 1rem;
    }
    .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-bottom: 0.8rem;
    }
    .head h1 {
      margin: 0;
      font-size: 1.2rem;
      font-family: "Sora", sans-serif;
    }
    .stats {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .stat {
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(8, 24, 42, 0.65);
      color: #dff0ff;
      padding: 0.22rem 0.58rem;
      font-size: 0.78rem;
    }
    .filters {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    .chip {
      border: 1px solid rgba(153, 197, 244, 0.32);
      border-radius: 999px;
      background: rgba(9, 25, 45, 0.78);
      color: #dff0ff;
      font-size: 0.8rem;
      padding: 0.22rem 0.58rem;
      cursor: pointer;
    }
    .chip.active {
      border-color: rgba(124, 211, 255, 0.6);
      background: rgba(45, 160, 241, 0.25);
      color: #fff;
    }
    .list {
      display: grid;
      gap: 0.6rem;
    }
    .row-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(9, 25, 45, 0.8);
      padding: 0.7rem;
    }
    .row-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .badge-soft {
      border: 1px solid rgba(153, 197, 244, 0.36);
      border-radius: 999px;
      padding: 0.14rem 0.46rem;
      font-size: 0.72rem;
      color: #cde6ff;
      background: rgba(25, 64, 98, 0.35);
    }
    .muted {
      color: var(--muted);
      font-size: 0.82rem;
      margin-top: 0.32rem;
    }
    .actions {
      margin-top: 0.55rem;
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }
    .actions select,
    .actions input {
      border: 1px solid rgba(153, 197, 244, 0.26);
      border-radius: 9px;
      background: rgba(7, 20, 36, 0.88);
      color: #eaf5ff;
      font-size: 0.8rem;
      padding: 0.35rem 0.5rem;
    }
    .actions button {
      border: 0;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #03263f;
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      padding: 0.33rem 0.72rem;
      cursor: pointer;
    }
    .panel-card {
      margin-bottom: 0.8rem;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 0.65rem;
      background: rgba(9, 25, 45, 0.74);
    }
    .card-title {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 0.42rem;
    }
    .link-stat {
      text-decoration: none;
    }
    .status {
      min-height: 1.25rem;
      margin-top: 0.6rem;
      color: #93f1c8;
      font-size: 0.85rem;
    }
  </style>
  <link rel="stylesheet" href="css/navbar-chat-theme.css">
</head>
<body data-seo-path="/admin-moderation.html">
  <nav class="navbar navbar-expand-lg navbar-dark glass-nav">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <img src="assets/logo.png" height="35" alt="ASCAPDX">
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door me-1"></i> Home</a></li>
          <li class="nav-item"><a class="nav-link" href="chat.html"><i class="bi bi-chat-dots me-1"></i> Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="posts.html"><i class="bi bi-grid me-1"></i> Posts</a></li>
          <li class="nav-item"><a class="nav-link active" href="admin-moderation.html"><i class="bi bi-shield-check me-1"></i> Moderation</a></li>
          <li class="nav-item"><a class="nav-link" href="admin-security.html"><i class="bi bi-shield-lock me-1"></i> Security</a></li>
          <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main id="adminMain" style="display:none;">
    <section class="shell">
      <div class="head">
        <h1>Admin Moderation Panel</h1>
        <div class="stats">
          <a href="admin-security.html" class="stat link-stat">Open Security Panel</a>
          <div id="stats"></div>
        </div>
      </div>
      <div class="filters">
        <button class="chip active" data-status="">All</button>
        <button class="chip" data-status="open">Open</button>
        <button class="chip" data-status="reviewing">Reviewing</button>
        <button class="chip" data-status="resolved">Resolved</button>
        <button class="chip" data-status="dismissed">Dismissed</button>
      </div>
      <div class="panel-card">
        <div class="card-title">User Verification</div>
        <div class="actions" style="margin-top:0;">
          <input id="verifyUsernameInput" type="text" maxlength="40" placeholder="username">
          <button type="button" id="verifyBtn">Verify</button>
          <button type="button" id="unverifyBtn">Unverify</button>
        </div>
        <div class="actions">
          <input id="roleUsernameInput" type="text" maxlength="40" placeholder="username">
          <button type="button" id="promoteAdminBtn">Promote Admin</button>
          <button type="button" id="demoteUserBtn">Demote User</button>
        </div>
      </div>
      <div class="panel-card">
        <div class="card-title">Quick Report Actions</div>
        <div class="actions" style="margin-top:0;">
          <button type="button" id="bulkReviewingBtn">Mark Visible as Reviewing</button>
          <button type="button" id="bulkResolvedBtn">Mark Visible as Resolved</button>
          <button type="button" id="bulkDismissedBtn">Mark Visible as Dismissed</button>
        </div>
      </div>
      <div id="reportsList" class="list"></div>
      <div id="status" class="status"></div>
    </section>
  </main>

  <script src="js/app-config.js"></script>
  <script src="js/user-navbar-menu.js"></script>
  <script>
    const session = (window.APP_CONFIG && window.APP_CONFIG.requireAuth && window.APP_CONFIG.requireAuth()) || null;

    const API_ORIGIN = (window.APP_CONFIG && window.APP_CONFIG.backendOrigin) || "http://localhost:5000";
    const API_ADMIN = `${API_ORIGIN}/api/admin`;
    const listEl = document.getElementById("reportsList");
    const statsEl = document.getElementById("stats");
    const statusEl = document.getElementById("status");
    const chips = Array.from(document.querySelectorAll("[data-status]"));
    const verifyUsernameInput = document.getElementById("verifyUsernameInput");
    const verifyBtn = document.getElementById("verifyBtn");
    const unverifyBtn = document.getElementById("unverifyBtn");
    const roleUsernameInput = document.getElementById("roleUsernameInput");
    const promoteAdminBtn = document.getElementById("promoteAdminBtn");
    const demoteUserBtn = document.getElementById("demoteUserBtn");
    const bulkReviewingBtn = document.getElementById("bulkReviewingBtn");
    const bulkResolvedBtn = document.getElementById("bulkResolvedBtn");
    const bulkDismissedBtn = document.getElementById("bulkDismissedBtn");
    let activeStatus = "";

    function escapeHtml(value) {
      return String(value || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    async function authFetchJson(url, options = {}) {
      const fetcher = window.APP_CONFIG && window.APP_CONFIG.authFetch ? window.APP_CONFIG.authFetch : fetch;
      const res = await fetcher(url, options);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || "Request failed");
      return data;
    }

    function formatDateTime(value) {
      const d = new Date(value || 0);
      if (!d.getTime()) return "";
      return d.toLocaleString();
    }

    async function loadStats() {
      const stats = await authFetchJson(`${API_ADMIN}/reports/stats`);
      statsEl.innerHTML = `
        <span class="stat">Total: ${Number(stats.total || 0)}</span>
        <span class="stat">Open: ${Number(stats.open || 0)}</span>
        <span class="stat">Reviewing: ${Number(stats.reviewing || 0)}</span>
        <span class="stat">Resolved: ${Number(stats.resolved || 0)}</span>
        <span class="stat">Dismissed: ${Number(stats.dismissed || 0)}</span>
      `;
    }

    function renderReports(items) {
      if (!Array.isArray(items) || !items.length) {
        listEl.innerHTML = '<p class="muted">No reports found for this filter.</p>';
        return;
      }
      listEl.innerHTML = items.map((item) => `
        <article class="row-card" data-report-id="${escapeHtml(item.id)}">
          <div class="row-head">
            <div>
              <strong>${escapeHtml(item.targetType || "unknown").toUpperCase()} report</strong>
              <span class="badge-soft">${escapeHtml(item.status || "open")}</span>
            </div>
            <small class="muted">${escapeHtml(formatDateTime(item.createdAt))}</small>
          </div>
          <div class="muted">Reporter: @${escapeHtml(item.reporterUsername || "")} | Target: ${item.targetUsername ? `@${escapeHtml(item.targetUsername)}` : escapeHtml(item.targetId || "unknown")}</div>
          <div class="muted">Reason: ${escapeHtml(item.reason || "")}</div>
          ${item.details ? `<div class="muted">Details: ${escapeHtml(item.details)}</div>` : ""}
          ${item.reviewedBy ? `<div class="muted">Reviewed by @${escapeHtml(item.reviewedBy)} ${item.reviewedAt ? `on ${escapeHtml(formatDateTime(item.reviewedAt))}` : ""}</div>` : ""}
          ${item.moderatorNote ? `<div class="muted">Note: ${escapeHtml(item.moderatorNote)}</div>` : ""}
          <div class="actions">
            <select data-next-status>
              <option value="open" ${item.status === "open" ? "selected" : ""}>open</option>
              <option value="reviewing" ${item.status === "reviewing" ? "selected" : ""}>reviewing</option>
              <option value="resolved" ${item.status === "resolved" ? "selected" : ""}>resolved</option>
              <option value="dismissed" ${item.status === "dismissed" ? "selected" : ""}>dismissed</option>
            </select>
            <input type="text" maxlength="300" placeholder="moderator note (optional)" data-note>
            <button type="button" data-save-status>Save</button>
          </div>
        </article>
      `).join("");
    }

    async function loadReports() {
      const q = activeStatus ? `?status=${encodeURIComponent(activeStatus)}&limit=200` : "?limit=200";
      const data = await authFetchJson(`${API_ADMIN}/reports${q}`);
      renderReports(data.items || []);
    }

    async function saveReportStatus(card) {
      const reportId = card.getAttribute("data-report-id");
      const select = card.querySelector("[data-next-status]");
      const note = card.querySelector("[data-note]");
      const status = select ? select.value : "";
      const moderatorNote = note ? note.value : "";
      if (!reportId || !status) return;
      await authFetchJson(`${API_ADMIN}/reports/${encodeURIComponent(reportId)}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status, moderatorNote })
      });
    }

    async function setUserVerification(verified) {
      const uname = String((verifyUsernameInput && verifyUsernameInput.value) || "").trim();
      if (!uname) throw new Error("Enter a username first");
      const data = await authFetchJson(`${API_ADMIN}/users/${encodeURIComponent(uname)}/verify`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ verified: !!verified })
      });
      return data;
    }

    async function setUserRole(role) {
      const uname = String((roleUsernameInput && roleUsernameInput.value) || "").trim();
      if (!uname) throw new Error("Enter a username first");
      const data = await authFetchJson(`${API_ADMIN}/users/${encodeURIComponent(uname)}/role`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role })
      });
      return data;
    }

    async function bulkUpdateVisibleReports(status) {
      const cards = Array.from(listEl.querySelectorAll("[data-report-id]"));
      if (!cards.length) return 0;
      let updated = 0;
      for (const card of cards) {
        const reportId = card.getAttribute("data-report-id");
        if (!reportId) continue;
        const noteInput = card.querySelector("[data-note]");
        const moderatorNote = noteInput ? String(noteInput.value || "").trim() : "";
        await authFetchJson(`${API_ADMIN}/reports/${encodeURIComponent(reportId)}/status`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status, moderatorNote })
        });
        updated += 1;
      }
      return updated;
    }

    chips.forEach((chip) => {
      chip.addEventListener("click", async () => {
        activeStatus = chip.getAttribute("data-status") || "";
        chips.forEach((el) => el.classList.toggle("active", el === chip));
        try {
          await loadReports();
        } catch (err) {
          statusEl.textContent = err.message || "Could not load reports.";
        }
      });
    });

    listEl.addEventListener("click", async (event) => {
      const saveBtn = event.target.closest("[data-save-status]");
      if (!saveBtn) return;
      const card = event.target.closest("[data-report-id]");
      if (!card) return;
      saveBtn.disabled = true;
      try {
        await saveReportStatus(card);
        statusEl.textContent = "Report updated.";
        await loadReports();
        await loadStats();
      } catch (err) {
        statusEl.textContent = err.message || "Could not update report.";
      } finally {
        saveBtn.disabled = false;
      }
    });

    if (verifyBtn) {
      verifyBtn.addEventListener("click", async () => {
        verifyBtn.disabled = true;
        try {
          const data = await setUserVerification(true);
          statusEl.textContent = data.message || "User verified.";
        } catch (err) {
          statusEl.textContent = err.message || "Could not verify user.";
        } finally {
          verifyBtn.disabled = false;
        }
      });
    }

    if (unverifyBtn) {
      unverifyBtn.addEventListener("click", async () => {
        unverifyBtn.disabled = true;
        try {
          const data = await setUserVerification(false);
          statusEl.textContent = data.message || "User unverified.";
        } catch (err) {
          statusEl.textContent = err.message || "Could not unverify user.";
        } finally {
          unverifyBtn.disabled = false;
        }
      });
    }

    if (promoteAdminBtn) {
      promoteAdminBtn.addEventListener("click", async () => {
        promoteAdminBtn.disabled = true;
        try {
          const data = await setUserRole("admin");
          statusEl.textContent = data.message || "User promoted to admin.";
        } catch (err) {
          statusEl.textContent = err.message || "Could not update role.";
        } finally {
          promoteAdminBtn.disabled = false;
        }
      });
    }

    if (demoteUserBtn) {
      demoteUserBtn.addEventListener("click", async () => {
        demoteUserBtn.disabled = true;
        try {
          const data = await setUserRole("user");
          statusEl.textContent = data.message || "User demoted to user.";
        } catch (err) {
          statusEl.textContent = err.message || "Could not update role.";
        } finally {
          demoteUserBtn.disabled = false;
        }
      });
    }

    async function runBulkStatusAction(nextStatus, triggerBtn) {
      if (!triggerBtn) return;
      triggerBtn.disabled = true;
      try {
        const updated = await bulkUpdateVisibleReports(nextStatus);
        statusEl.textContent = `Updated ${updated} reports to ${nextStatus}.`;
        await loadReports();
        await loadStats();
      } catch (err) {
        statusEl.textContent = err.message || "Bulk update failed.";
      } finally {
        triggerBtn.disabled = false;
      }
    }

    if (bulkReviewingBtn) {
      bulkReviewingBtn.addEventListener("click", () => runBulkStatusAction("reviewing", bulkReviewingBtn));
    }
    if (bulkResolvedBtn) {
      bulkResolvedBtn.addEventListener("click", () => runBulkStatusAction("resolved", bulkResolvedBtn));
    }
    if (bulkDismissedBtn) {
      bulkDismissedBtn.addEventListener("click", () => runBulkStatusAction("dismissed", bulkDismissedBtn));
    }

    async function resolveCurrentRole() {
      const me = await authFetchJson(`${API_ORIGIN}/api/auth/session`);
      const role = String((me && me.role) || "user");
      localStorage.setItem("userRole", role);
      return role;
    }

    (async () => {
      try {
        const role = await resolveCurrentRole();
        if (role !== "admin") {
          window.location.href = "index.html";
          return;
        }
        if (document.getElementById("adminMain")) {
          document.getElementById("adminMain").style.display = "";
        }
        await loadStats();
        await loadReports();
      } catch (err) {
        statusEl.textContent = err.message || "Admin access required.";
        setTimeout(() => {
          window.location.href = "login.html";
        }, 700);
      }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="js/seo-meta.js"></script>
</body>
</html>




<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register</title>
  <meta name="description" content="Create your ASCAPDX Digital account to share posts, stories, and connect with others.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Register | ASCAPDX Digital">
  <meta property="og:description" content="Create your ASCAPDX Digital account and join the community.">
  <meta property="og:url" content="">
  <meta property="og:image" content="assets/logo.png">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Register | ASCAPDX Digital">
  <meta name="twitter:description" content="Create your ASCAPDX Digital account and join the community.">
  <meta name="twitter:url" content="">
  <meta name="twitter:image" content="assets/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- AOS Animation -->
  <!-- <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="css/auth-signup.css">
</head>

<body data-seo-path="/signup.html">
  <video muted loop playsinline class="video-bg">
    <source src="assets/chat2.mp4" type="video/mp4">
    Your browser does not support video.
  </video>
<div class="glass-card" data-aos="fade-up">
     <h1 class="signup-heading">Create an Account</h1>
     <p class="signup-subtitle">Join ASCAPDX Digital to share, connect, and stay updated.</p>

    <form id="registerForm" class="space-y-4">

      <div>
        <label class="form-label mb-1">Name</label>
        <input type="text" name="name" placeholder="Name"  required class="form-control">
      </div>

      <div>
        <label class="form-label mb-1">Email</label>
        <div class="email-otp-row">
          <input type="email" name="email" id="emailInput" placeholder="Email" required class="form-control form-control-sm">
          <button type="button" id="requestOtpBtn" class="btn btn-outline-light btn-sm px-2 py-1">Request OTP</button>
        </div>
      </div>

      <div id="otpSection" style="display:none;">
        <label class="form-label mb-1">Email OTP</label>
        <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" class="form-control">
        <button type="button" id="verifyOtpBtn" class="btn btn-outline-light btn-sm mt-2">Verify OTP</button>
      </div>

      <div>
        <label class="form-label mb-1">Password</label>
        <input type="password" name="password" placeholder="Password" required class="form-control">
      </div>

      <button type="submit" id="registerBtn" class="btn btn-primary" disabled>Register</button>

    </form>

    <p class="auth-footer">
      Already have an account? <a href="login.html">Login</a>
    </p>

    <p id="msg"></p>
  </div>
<script src="js/seo-meta.js"></script>
<script src="js/ui-feedback.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
     AOS.init();
    const bgVideo = document.querySelector(".video-bg");
    if (bgVideo) {
      bgVideo.autoplay = false;
      const startBgVideo = () => {
        const p = bgVideo.play();
        if (p && typeof p.catch === "function") p.catch(() => {});
      };
      const stopBgVideo = () => {
        try { bgVideo.pause(); } catch (err) {}
        bgVideo.currentTime = 0;
      };
      bgVideo.addEventListener("mouseenter", startBgVideo);
      bgVideo.addEventListener("mouseleave", stopBgVideo);
      bgVideo.addEventListener("touchstart", startBgVideo, { passive: true });
      stopBgVideo();
    }

    const form = document.getElementById("registerForm");
    const msg = document.getElementById("msg");
    const emailInput = document.getElementById("emailInput");
    const requestOtpBtn = document.getElementById("requestOtpBtn");
    const otpSection = document.getElementById("otpSection");
    const otpInput = document.getElementById("otpInput");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const registerBtn = document.getElementById("registerBtn");

    const API_ORIGIN = localStorage.getItem("backendOrigin") || "http://localhost:5000";
    let otpVerified = false;
    let otpEmail = "";

    function resetOtpState() {
      otpVerified = false;
      otpEmail = "";
      registerBtn.disabled = true;
      otpInput.value = "";
      otpSection.style.display = "none";
      verifyOtpBtn.disabled = false;
      verifyOtpBtn.textContent = "Verify OTP";
    }

    function setMessage(text, ok = false) {
      msg.style.color = ok ? "#9ff0c2" : "#ff9ca8";
      msg.textContent = text;
    }

    requestOtpBtn.addEventListener("click", async () => {
      const email = String(emailInput.value || "").trim().toLowerCase();
      if (!email) {
        setMessage("Please enter your email first.");
        return;
      }
      requestOtpBtn.disabled = true;
      requestOtpBtn.classList.add("is-loading");
      requestOtpBtn.textContent = "Sending...";
      try {
        const res = await fetch(`${API_ORIGIN}/api/auth/request-otp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (!res.ok) {
          setMessage(data.message || "Could not send OTP.");
          return;
        }
        otpEmail = email;
        otpSection.style.display = "block";
        setMessage(data.message || "OTP sent to your email.", true);
      } catch (err) {
        setMessage("Server error while requesting OTP.");
        requestOtpBtn.disabled = false;
      } finally {
        requestOtpBtn.classList.remove("is-loading");
        requestOtpBtn.disabled = false;
        requestOtpBtn.textContent = "Request OTP";
      }
    });

    verifyOtpBtn.addEventListener("click", async () => {
      const email = String(emailInput.value || "").trim().toLowerCase();
      const otp = String(otpInput.value || "").trim();
      if (!email || !otp) {
        setMessage("Enter email and OTP.");
        return;
      }
      if (otpEmail && otpEmail !== email) {
        setMessage("Email changed. Please request OTP again.");
        resetOtpState();
        return;
      }
      verifyOtpBtn.disabled = true;
      verifyOtpBtn.textContent = "Verifying...";
      try {
        const res = await fetch(`${API_ORIGIN}/api/auth/verify-otp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp })
        });
        const data = await res.json();
        if (!res.ok) {
          setMessage(data.message || "OTP verification failed.");
          return;
        }
        otpVerified = true;
        registerBtn.disabled = false;
        setMessage("Email verified. You can now register.", true);
      } catch (err) {
        setMessage("Server error while verifying OTP.");
      } finally {
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.textContent = "Verify OTP";
      }
    });

    emailInput.addEventListener("input", () => {
      const nextEmail = String(emailInput.value || "").trim().toLowerCase();
      if (otpEmail && otpEmail !== nextEmail) {
        resetOtpState();
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";

      const formData = new FormData(form);
      const name = formData.get("name").trim();
      const email = formData.get("email").trim().toLowerCase();
      const password = formData.get("password");
      if (!otpVerified || otpEmail !== email) {
        setMessage("Please verify email OTP before registering.");
        return;
      }

      try {
        const res = await fetch(`${API_ORIGIN}/api/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          setMessage(data.message || "Registration failed");
        } else {
          if (window.UIFeedback && typeof window.UIFeedback.toast === "function") {
            window.UIFeedback.toast("Registration successful! Please login.", "success");
          }
          window.location.href = "login.html";
        }

      } catch (err) {
        console.error(err);
        setMessage("Server error. Please try again later.");
      }
    });
  </script>

</body>

</html>


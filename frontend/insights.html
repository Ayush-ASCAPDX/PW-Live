<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insights | ASCAPDX Digital</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="manifest" href="manifest.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{margin:0;background:#071325;color:#e9f4ff;font-family:Arial,sans-serif}
    .wrap{max-width:980px;margin:6rem auto 1rem;padding:0 1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem}
    .kpi{border:1px solid rgba(153,197,244,.26);border-radius:12px;background:rgba(12,30,52,.82);padding:.6rem}
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.7rem;margin-top:.8rem}
    .chart-card{border:1px solid rgba(153,197,244,.22);border-radius:12px;background:rgba(9,24,41,.82);padding:.65rem}
    .chart-title{font-size:.88rem;font-weight:700;margin-bottom:.45rem}
    .chart-canvas{width:100%;height:220px;display:block}
    .list{margin-top:.8rem;display:grid;gap:.45rem}
    .rowx{border:1px solid rgba(153,197,244,.2);border-radius:10px;background:rgba(9,24,41,.82);padding:.5rem}
    .muted{color:#9ec3e8;font-size:.82rem}
  </style>
  <link rel="stylesheet" href="css/navbar-chat-theme.css">
</head>
<body data-seo-path="/insights.html">
  <nav class="navbar navbar-expand-lg navbar-dark glass-nav">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"><img src="assets/logo.png" height="35" alt="ASCAPDX"></a>
      <div class="navbar-nav ms-auto"><a class="nav-link" href="settings.html">Settings</a></div>
    </div>
  </nav>
  <main class="wrap">
    <h1 style="font-size:1.2rem;margin-bottom:.8rem;">Creator Insights</h1>
    <div id="kpis" class="grid"></div>
    <section class="chart-grid">
      <article class="chart-card">
        <div class="chart-title">Totals Overview</div>
        <canvas id="totalsChart" class="chart-canvas" width="480" height="220" aria-label="Totals overview chart"></canvas>
      </article>
      <article class="chart-card">
        <div class="chart-title">Top Posts (Engagement)</div>
        <canvas id="topPostsChart" class="chart-canvas" width="480" height="220" aria-label="Top posts engagement chart"></canvas>
      </article>
    </section>
    <div id="list" class="list"></div>
    <p id="status" class="muted"></p>
  </main>
  <script src="js/app-config.js"></script>
  <script>
    (window.APP_CONFIG && window.APP_CONFIG.requireAuth && window.APP_CONFIG.requireAuth());
    const API = ((window.APP_CONFIG && window.APP_CONFIG.backendOrigin) || "http://localhost:5000") + "/api/posts/insights/me";
    const authFetch = (url, opts = {}) => (window.APP_CONFIG && window.APP_CONFIG.authFetch ? window.APP_CONFIG.authFetch(url, opts) : fetch(url, opts));
    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function drawBarChart(canvasId, labels, values, color) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);
      const left = 48;
      const right = 16;
      const top = 16;
      const bottom = 34;
      const chartW = width - left - right;
      const chartH = height - top - bottom;
      const safeVals = (values || []).map((v) => Number(v || 0));
      const maxVal = Math.max(1, ...safeVals);

      ctx.strokeStyle = "rgba(160,200,240,0.24)";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = top + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(left + chartW, y);
        ctx.stroke();
      }

      const barCount = Math.max(1, safeVals.length);
      const slotW = chartW / barCount;
      const barW = Math.max(12, slotW * 0.56);
      ctx.fillStyle = color || "#58b8ff";
      ctx.font = "11px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for (let i = 0; i < barCount; i++) {
        const v = safeVals[i] || 0;
        const h = Math.max(2, (v / maxVal) * chartH);
        const x = left + slotW * i + (slotW - barW) / 2;
        const y = top + chartH - h;
        ctx.fillRect(x, y, barW, h);
        ctx.fillStyle = "#9ec3e8";
        const label = String((labels && labels[i]) || "");
        ctx.fillText(label.slice(0, 9), x + barW / 2, top + chartH + 8);
        ctx.fillStyle = color || "#58b8ff";
      }
    }

    async function loadInsights() {
      const res = await authFetch(API);
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Failed to load insights");
      const totals = data.totals || {};
      const entries = [
        ["Posts", totals.posts || 0],
        ["Likes", totals.likes || 0],
        ["Comments", totals.comments || 0],
        ["Shares", totals.shares || 0],
        ["Saves", totals.saves || 0],
        ["Scheduled", totals.scheduled || 0],
        ["Archived", totals.archived || 0]
      ];
      document.getElementById("kpis").innerHTML = entries.map(([k, v]) => `<div class="kpi"><div class="muted">${escapeHtml(k)}</div><strong>${Number(v || 0)}</strong></div>`).join("");
      drawBarChart("totalsChart", ["Likes", "Comments", "Shares", "Saves"], [totals.likes || 0, totals.comments || 0, totals.shares || 0, totals.saves || 0], "#61c2ff");

      const items = Array.isArray(data.items) ? data.items : [];
      const topPosts = [...items]
        .map((p) => ({
          label: String(p.caption || "Post").slice(0, 12) || "Post",
          score: Number(p.likesCount || 0) + Number(p.commentsCount || 0) + Number(p.sharesCount || 0) + Number(p.savesCount || 0)
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 6);
      drawBarChart("topPostsChart", topPosts.map((p) => p.label), topPosts.map((p) => p.score), "#7fd4ff");

      document.getElementById("list").innerHTML = items.map((p) => `
        <article class="rowx">
          <strong>${escapeHtml(String(p.caption || "No caption").slice(0, 80))}</strong>
          <div class="muted">${new Date(p.createdAt || Date.now()).toLocaleString()} ${p.archived ? " - Archived" : ""} ${p.isPublished ? "" : " - Scheduled"}</div>
          <div class="muted">${Number(p.likesCount || 0)} likes - ${Number(p.commentsCount || 0)} comments - ${Number(p.sharesCount || 0)} shares - ${Number(p.savesCount || 0)} saves</div>
        </article>
      `).join("") || '<p class="muted">No posts found.</p>';
    }

    loadInsights().catch((err) => {
      document.getElementById("status").textContent = err.message || "Failed to load insights.";
    });
  </script>
  <script src="js/user-navbar-menu.js"></script>
  <script src="js/pwa-register.js"></script>
  <script src="js/seo-meta.js"></script>
</body>
</html>
